<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divide la cuenta</title>
    <style>
        /* Variables CSS para fácil personalización desde Figma */
        :root {
            /* Colores del sistema */
            --primary: #3e56cf;
            --primary-light: #4e69f2;
            --secondary: #FFB323;
            --tertiary: #51993d;
            --tertiary-light: #73cb5b;
            --accent: #00D1FF;
            --success: #00BA88;
            --error: #FF4C51;
          
            /* Divider */
            .divider {
            border-top: 1px solid #efefef;
        }
            
            /* Escala de grises */
            --gray-100: #F9FAFB;
            --gray-200: #F3F4F6;
            --gray-300: #E5E7EB;
            --gray-400: #D1D5DB;
            --gray-500: #9CA3AF;
            --gray-600: #6B7280;
            --gray-700: #4B5563;
            --gray-800: #1F2937;
            --gray-900: #111827;
            
            /* Espaciado - Basado en sistema de 4px */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            
            /* Tipografía */
            --font-primary: 'Inter', -apple-system, system-ui, sans-serif;
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-md: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 24px;
            --font-size-2xl: 32px;
            
            /* Border radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
            --radius-full: 9999px;
            
            /* Sombras */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Reset y estilos base */
        * {
            margin: 0;
            padding: 2px;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-md);
        }

        .header {
            text-align: center;
            padding: var(--space-xl) 0;
        }

        .header h1 {
            font-size: var(--font-size-2xl);
            color: var(--primary);
            margin-bottom: var(--space-xs);
        }

        /* Componentes */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-md);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .input-group {
            margin-bottom: var(--space-md);
        }

        .label {
            display: block;
            font-size: var(--font-size-sm);
            color: var(--gray-700);
            margin-bottom: var(--space-xs);
        }

        .input {
            width: 100%;
            padding: var(--space-sm);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(127, 84, 241, 0.1);
        }

        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-sm) var(--space-lg);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .button-primary {
            background-color: var(--primary);
            color: white;
        }

        .button-primary:hover {
            background-color: var(--primary-light);
        }

        .button-secondary {
            background-color: white;
            border: 2px solid var(--gray-300);
            color: var(--gray-700);
        }

        .button-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .button-tertiary {
            background: #51993d;
            color: #ffffff !important;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .button-tertiary:hover {
            background: white;
            color: #51993d !important;
            border: 2px solid #51993d;
        }

        .button-danger {
            background-color: var(--error);
            color: white;
        }

        .person-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            border: 2px solid var(--gray-200);
        }

        .shared-item-card {
            background: var(--gray-100);
            border: 2px solid var(--primary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            cursor: pointer;
        }

        .results {
            margin-top: var(--space-2xl);
        }

        .result-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            border-left: 4px solid var(--primary);
        }

        .total-amount {
            font-size: var(--font-size-xl);
            color: var(--primary);
            margin-top: var(--space-md);
        }

        .button-stack {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
            margin-top: var(--space-md);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: var(--space-sm);
            }

            .button-stack {
                flex-direction: column;
                width: 100%;
            }

            .button {
                width: 100%;
            }

            .person-card,
            .shared-item-card {
                padding: var(--space-md);
            }
        }

        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-in {
            animation: fadeIn 0.3s ease-out;
        }

        .button-tertiary {
            background: #51993d;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .button-tertiary:hover {
            background: var(--gray-200);
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .input.error {
            border-color: #dc3545;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: var(--space-xl);
            border-radius: 8px;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalIn 0.3s ease-out;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-buttons {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-xl);
        }

        @media (max-width: 768px) {
            .modal {
                padding: var(--space-lg);
                width: 95%;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Divide la cuenta</h1>
            <p>En línea, sin descargar apps</p>
        </header>

        <div class="person-card animate-in" style="margin-bottom: var(--space-xl);">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" 
                 onclick="toggleDescription(this)">
                <h3 style="color: var(--primary); margin-bottom: var(--space-md);">¿Cómo funciona?</h3>
                <span class="toggle-icon" style="font-size: 1.5em; color: var(--primary);">−</span>
            </div>
            <div class="description-content">
                <ol style="color: var(--gray-700); padding-left: var(--space-xl);">
                    <li style="margin-bottom: var(--space-sm);">Agrega a cada persona que participará en la cuenta</li>
                    <li style="margin-bottom: var(--space-sm);">Ingresa los platillos individuales de cada persona</li>
                    <li style="margin-bottom: var(--space-sm);">Si hay platillos compartidos, agrégalos y selecciona quiénes participan</li>
                    <li style="margin-bottom: var(--space-sm);">Opcionalmente, agrega el porcentaje de propina para cada persona</li>
                    <li>¡Listo! Presiona calcular y obtén el desglose detallado</li>
                </ol>
            </div>
        </div>

        <div class="button-group" style="display: flex; gap: var(--space-md); justify-content: center; margin-bottom: var(--space-xl);">
            <button onclick="addFirstPerson()" class="button button-primary" id="startButton">
                Comenzar
            </button>
        </div>

        <div id="people-container"></div>

        <div id="action-buttons" style="display: none; margin: var(--space-xl) 0;">
            <div class="button-group" style="display: flex; gap: var(--space-md); justify-content: center;">
                <button onclick="addPerson()" class="button button-tertiary" id="addPersonButton">
                    Agregar persona
                </button>
                <button onclick="addSharedItem()" class="button button-secondary" id="sharedButton">
                    Agregar platillo compartido
                </button>
            </div>
        </div>

        <div id="shared-items-container"></div>

        <div class="divider" style="margin: var(--space-xl) 0;"></div>

        <button onclick="calculateTotal()" class="button button-primary" style="width: 100%; margin-top: var(--space-xs); display: none;" id="calculateButton">
            Calcular totales
        </button>

        <div id="results" class="results"></div>
    </div>

    <div class="modal-overlay" id="resultsModal">
        <div class="modal">
            <div id="modalContent"></div>
            <div class="modal-buttons">
                <button onclick="closeModal()" class="button button-secondary" style="flex: 1;">
                    Seguir editando
                </button>
                <button onclick="resetCalculator()" class="button button-danger" style="flex: 1;">
                    Nueva cuenta
                </button>
            </div>
        </div>
    </div>

    <script>
      
        // El código JavaScript se mantiene igual que en la versión anterior
     
        let personCount = 0;
        let sharedItemCount = 0;
        function addFirstPerson() {
            // Ocultar el botón de comenzar
            document.getElementById('startButton').style.display = 'none';
            
            // Mostrar los botones de acción
            document.getElementById('action-buttons').style.display = 'block';
            
            addPerson();
        }

        function addPerson() {
            personCount++;
            const container = document.getElementById('people-container');
            const personDiv = document.createElement('div');
            personDiv.className = 'person-card animate-in';
            personDiv.id = `person-${personCount}`;
            
            personDiv.innerHTML = `
                <h3 style="margin-bottom: var(--space-md);">Persona ${personCount}</h3>
                <div class="input-group">
                    <label class="label">Nombre</label>
                    <input type="text" 
                           class="input" 
                           placeholder="Escribe aquí" 
                           id="name-${personCount}"
                           onblur="validateName(this)"
                           oninput="checkInitialFields(${personCount})">
                    <div class="error-message">El nombre es requerido</div>
                </div>
                <div class="input-group">
                    <label class="label">Propina</label>
                    <div style="position: relative;">
                        <input type="number" 
                               class="input" 
                               id="tip-${personCount}" 
                               style="padding-right: 24px;"
                               placeholder="0"
                               min="0" 
                               max="100"
                               inputmode="decimal"
                               pattern="[0-9]*"
                               onblur="validateTip(this)"
                               oninput="checkInitialFields(${personCount})">
                        <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-600);">%</span>
                    </div>
                    <div class="error-message">La propina debe estar entre 0 y 100</div>
                </div>
                <div id="items-${personCount}"></div>
                
                <div class="divider"></div>
                
                <div class="button-stack">
                    <button onclick="addItem(${personCount})" 
                            class="button button-secondary" 
                            id="addItemBtn-${personCount}" 
                            style="display: none;">
                        Agregar otro platillo
                    </button>
                    ${personCount > 1 ? `
                        <button onclick="deletePerson(${personCount})" class="button button-danger">
                            Eliminar persona
                        </button>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(personDiv);
            addFirstItem(personCount);
            updateSharedSelects();
            document.getElementById('calculateButton').style.display = 'block';
        }

        function addFirstItem(personId) {
            const itemsContainer = document.getElementById(`items-${personId}`);
            const itemDiv = document.createElement('div');
            itemDiv.className = 'input-group animate-in';
            
            itemDiv.innerHTML = `
                <div class="divider"></div>
                <div style="display: grid; grid-template-columns: 1fr; gap: var(--space-sm); align-items: start;">
                    <div>
                        <label class="label">Nombre del platillo</label>
                        <input type="text" 
                               class="input" 
                               placeholder="Escribe aquí" 
                               onblur="validateItemName(this)"
                               oninput="checkInitialFields(${personId})"
                               id="firstItemName-${personId}">
                        <div class="error-message">El nombre del platillo es requerido</div>
                    </div>
                    <div>
                        <label class="label">Precio</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-600);">$</span>
                            <input type="number" 
                                   class="input" 
                                   style="padding-left: 24px;"
                                   step="0.01" 
                                   inputmode="decimal" 
                                   pattern="[0-9]*"
                                   placeholder="0.00"
                                   onblur="validatePrice(this)"
                                   oninput="checkInitialFields(${personId})"
                                   id="firstItemPrice-${personId}">
                        </div>
                        <div class="error-message">El precio debe ser mayor a 0</div>
                    </div>
                </div>
            `;
            
            itemsContainer.appendChild(itemDiv);
        }

        function checkInitialFields(personId) {
            const name = document.getElementById(`name-${personId}`).value.trim();
            const itemName = document.getElementById(`firstItemName-${personId}`).value.trim();
            const itemPrice = document.getElementById(`firstItemPrice-${personId}`).value.trim();
            const addItemBtn = document.getElementById(`addItemBtn-${personId}`);
            
            if (name && itemName && itemPrice && parseFloat(itemPrice) > 0) {
                addItemBtn.style.display = 'block';
            } else {
                addItemBtn.style.display = 'none';
            }
        }

        function addItem(personId) {
            const itemsContainer = document.getElementById(`items-${personId}`);
            const itemDiv = document.createElement('div');
            itemDiv.className = 'input-group animate-in';
            const itemCount = itemsContainer.children.length + 1;
            
            itemDiv.innerHTML = `
                <div class="divider"></div>
                <div style="display: grid; grid-template-columns: 1fr; gap: var(--space-sm); align-items: start;">
                    <div>
                        <label class="label">Nombre del platillo</label>
                        <input type="text" 
                               class="input" 
                               placeholder="Escribe aquí" 
                               onblur="validateItemName(this)"
                               oninput="checkAdditionalItem(this)"
                               id="itemName-${personId}-${itemCount}">
                        <div class="error-message">El nombre del platillo es requerido</div>
                    </div>
                    <div>
                        <label class="label">Precio</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-600);">$</span>
                            <input type="number" 
                                   class="input" 
                                   style="padding-left: 24px;"
                                   step="0.01" 
                                   inputmode="decimal" 
                                   pattern="[0-9]*"
                                   placeholder="0.00"
                                   onblur="validatePrice(this)"
                                   oninput="checkAdditionalItem(this)"
                                   id="itemPrice-${personId}-${itemCount}">
                        </div>
                        <div class="error-message">El precio debe ser mayor a 0</div>
                    </div>
                    <button class="button button-danger" 
                            onclick="deleteItem(this, ${personId})" 
                            style="justify-self: end; margin-top: var(--space-md); display: none;"
                            id="deleteBtn-${personId}-${itemCount}">
                        Eliminar platillo
                    </button>
                </div>
            `;
            
            itemsContainer.appendChild(itemDiv);
        }

        function checkAdditionalItem(input) {
            const itemDiv = input.closest('.input-group');
            const nameInput = itemDiv.querySelector('input[type="text"]');
            const priceInput = itemDiv.querySelector('input[type="number"]');
            const deleteButton = itemDiv.querySelector('.button-danger');
            
            if (nameInput.value.trim() && priceInput.value.trim() && parseFloat(priceInput.value) > 0) {
                deleteButton.style.display = 'block';
            } else {
                deleteButton.style.display = 'none';
            }
        }

        function deleteItem(button, personId) {
            const itemDiv = button.closest('.input-group');
            itemDiv.remove();
            
            // Reorganizar IDs de los items restantes
            const itemsContainer = document.getElementById(`items-${personId}`);
            const items = itemsContainer.getElementsByClassName('input-group');
            Array.from(items).forEach((item, index) => {
                const itemCount = index + 1;
                const nameInput = item.querySelector('input[type="text"]');
                const priceInput = item.querySelector('input[type="number"]');
                const deleteBtn = item.querySelector('.button-danger');
                
                if (nameInput) nameInput.id = `itemName-${personId}-${itemCount}`;
                if (priceInput) priceInput.id = `itemPrice-${personId}-${itemCount}`;
                if (deleteBtn) deleteBtn.id = `deleteBtn-${personId}-${itemCount}`;
            });
        }

        function addSharedItem() {
            sharedItemCount++;
            const container = document.getElementById('shared-items-container');
            
            if (!container.children.length) {
                container.innerHTML = '<h2 style="margin-bottom: var(--space-lg);">Items Compartidos</h2>';
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'shared-item-card animate-in';
            itemDiv.id = `shared-item-${sharedItemCount}`;
            
            itemDiv.innerHTML = `
                <div class="input-group">
                    <label class="label">Descripción</label>
                    <input type="text" 
                           class="input" 
                           placeholder="Descripción del item compartido"
                           onblur="validateSharedItem(this)"
                           oninput="handleSharedItemInput(this)">
                    <div class="error-message">La descripción es requerida</div>
                </div>
                <div class="input-group">
                    <label class="label">Precio</label>
                    <div style="position: relative;">
                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-600);">$</span>
                        <input type="number" 
                               class="input" 
                               style="padding-left: 24px;"
                               step="0.01" 
                               inputmode="decimal" 
                               pattern="[0-9]*"
                               placeholder="0.00"
                               onblur="validateSharedItem(this)"
                               oninput="handleSharedItemInput(this)">
                        <div class="error-message">El precio debe ser mayor a 0</div>
                    </div>
                </div>
                <div class="input-group">
                    <label class="label">Compartido entre:</label>
                    <div class="checkbox-group" id="shared-checkboxes-${sharedItemCount}">
                        ${generatePersonCheckboxes()}
                    </div>
                    <div class="error-message">Selecciona al menos una persona</div>
                </div>
                <button class="button button-danger" 
                        onclick="this.parentElement.remove()" 
                        style="display: none;">
                    Eliminar
                </button>
            `;
            
            container.appendChild(itemDiv);
        }

        function generatePersonCheckboxes() {
            let checkboxesHTML = '';
            for (let i = 1; i <= personCount; i++) {
                const name = document.getElementById(`name-${i}`).value || `Persona ${i}`;
                checkboxesHTML += `
                    <label style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-xs);">
                        <input type="checkbox" 
                               onchange="validateSharedItem(this); handleSharedItemInput(this)">
                        <span>${name}</span>
                    </label>
                `;
            }
            return checkboxesHTML;
        }

        function validateSharedItem(input) {
            const itemCard = input.closest('.shared-item-card');
            const nameInput = itemCard.querySelector('input[type="text"]');
            const priceInput = itemCard.querySelector('input[type="number"]');
            const checkboxes = itemCard.querySelector('.checkbox-group').getElementsByTagName('input');
            const deleteButton = itemCard.querySelector('.button-danger');
            
            let isValid = true;
            
            // Validar nombre
            if (!nameInput.value.trim()) {
                nameInput.classList.add('error');
                nameInput.nextElementSibling.style.display = 'block';
                isValid = false;
            } else {
                nameInput.classList.remove('error');
                nameInput.nextElementSibling.style.display = 'none';
            }
            
            // Validar precio
            const price = parseFloat(priceInput.value);
            if (!price || price <= 0) {
                priceInput.classList.add('error');
                priceInput.parentElement.nextElementSibling.style.display = 'block';
                isValid = false;
            } else {
                priceInput.classList.remove('error');
                priceInput.parentElement.nextElementSibling.style.display = 'none';
            }
            
            // Validar checkboxes
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const errorMessage = itemCard.querySelector('.checkbox-group + .error-message');
            if (checkedCount === 0) {
                errorMessage.style.display = 'block';
                isValid = false;
            } else {
                errorMessage.style.display = 'none';
            }
            
            return isValid;
        }

        function handleSharedItemInput(input) {
            const itemCard = input.closest('.shared-item-card');
            const nameInput = itemCard.querySelector('input[type="text"]');
            const priceInput = itemCard.querySelector('input[type="number"]');
            const checkboxes = itemCard.querySelector('.checkbox-group').getElementsByTagName('input');
            const deleteButton = itemCard.querySelector('.button-danger');
            
            // Mostrar botón de eliminar si todos los campos requeridos están llenos
            if (nameInput.value.trim() && 
                parseFloat(priceInput.value) > 0 && 
                Array.from(checkboxes).some(cb => cb.checked)) {
                deleteButton.style.display = 'block';
            } else {
                deleteButton.style.display = 'none';
            }
        }

        function updateSharedSelects() {
            const sharedItems = document.getElementById('shared-items-container').getElementsByClassName('shared-item-card');
            Array.from(sharedItems).forEach(item => {
                const checkboxGroup = item.querySelector('.checkbox-group');
                checkboxGroup.innerHTML = generatePersonCheckboxes();
            });
        }

        function deletePerson(personId) {
            const personDiv = document.getElementById(`person-${personId}`);
            personDiv.remove();
            updateSharedSelects();
        }

        function validateName(input) {
            const errorMessage = input.nextElementSibling;
            if (!input.value.trim()) {
                input.classList.add('error');
                errorMessage.style.display = 'block';
                return false;
            }
            input.classList.remove('error');
            errorMessage.style.display = 'none';
            return true;
        }

        function validateTip(input) {
            const errorMessage = input.parentElement.nextElementSibling;
            const value = parseFloat(input.value);
            if (input.value && (isNaN(value) || value < 0 || value > 100)) {
                input.classList.add('error');
                errorMessage.style.display = 'block';
                return false;
            }
            input.classList.remove('error');
            errorMessage.style.display = 'none';
            return true;
        }

        function validateItemName(input) {
            const errorMessage = input.nextElementSibling;
            if (!input.value.trim()) {
                input.classList.add('error');
                errorMessage.style.display = 'block';
                return false;
            }
            input.classList.remove('error');
            errorMessage.style.display = 'none';
            return true;
        }

        function validatePrice(input) {
            const errorMessage = input.parentElement.nextElementSibling;
            const value = parseFloat(input.value);
            if (!input.value || isNaN(value) || value <= 0) {
                input.classList.add('error');
                errorMessage.style.display = 'block';
                return false;
            }
            input.classList.remove('error');
            errorMessage.style.display = 'none';
            return true;
        }

        function calculateTotal() {
            // Validar que haya al menos una persona
            if (personCount === 0) {
                alert('Debes agregar al menos una persona para calcular los totales');
                return;
            }

            // Validar todos los campos antes de calcular
            let isValid = true;
            for (let i = 1; i <= personCount; i++) {
                const nameInput = document.getElementById(`name-${i}`);
                if (!validateName(nameInput)) {
                    isValid = false;
                }
            }

            if (!isValid) {
                alert('Por favor, corrige los errores antes de calcular los totales');
                return;
            }

            const modalContent = document.getElementById('modalContent');
            let totalGeneral = 0;
            const personTotals = [];

            // Calcular totales por persona
            for (let i = 1; i <= personCount; i++) {
                const name = document.getElementById(`name-${i}`).value || `Persona ${i}`;
                const tip = parseFloat(document.getElementById(`tip-${i}`).value) || 0;
                
                // Calcular items individuales
                let subtotal = 0;
                let itemsList = '';
                const itemsContainer = document.getElementById(`items-${i}`);
                const items = itemsContainer.getElementsByClassName('input-group');
                
                Array.from(items).forEach(item => {
                    const nameInput = item.querySelector('input[type="text"]');
                    const priceInput = item.querySelector('input[type="number"]');
                    if (nameInput && priceInput && nameInput.value && priceInput.value) {
                        const itemName = nameInput.value;
                        const itemPrice = parseFloat(priceInput.value);
                        subtotal += itemPrice;
                        itemsList += `
                            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                                <span>${itemName}</span>
                                <span>$${itemPrice.toFixed(2)}</span>
                            </div>
                        `;
                    }
                });

                // Calcular items compartidos
                let sharedTotal = 0;
                let sharedItemsList = '';
                const sharedContainer = document.getElementById('shared-items-container');
                if (sharedContainer) {
                    const sharedItems = sharedContainer.getElementsByClassName('shared-item-card');
                    Array.from(sharedItems).forEach(item => {
                        const nameInput = item.querySelector('input[type="text"]');
                        const priceInput = item.querySelector('input[type="number"]');
                        const checkboxes = item.querySelector('.checkbox-group').getElementsByTagName('input');
                        
                        if (nameInput && priceInput && checkboxes) {
                            const itemName = nameInput.value;
                            const itemPrice = parseFloat(priceInput.value) || 0;
                            const participantes = Array.from(checkboxes).filter(cb => cb.checked).length;
                            
                            if (participantes > 0 && checkboxes[i-1].checked) {
                                const precioPorPersona = itemPrice / participantes;
                                sharedTotal += precioPorPersona;
                                sharedItemsList += `
                                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                                        <span>${itemName} (compartido entre ${participantes})</span>
                                        <span>$${precioPorPersona.toFixed(2)}</span>
                                    </div>
                                `;
                            }
                        }
                    });
                }

                // Calcular totales finales
                const subtotalConCompartidos = subtotal + sharedTotal;
                const tipAmount = (subtotalConCompartidos * tip) / 100;
                const total = subtotalConCompartidos + tipAmount;
                totalGeneral += total;

                personTotals.push({
                    name,
                    itemsList,
                    sharedItemsList,
                    subtotal: subtotalConCompartidos,
                    tip,
                    tipAmount,
                    total
                });
            }

            // Generar HTML de resultados
            let resultHTML = `
                <h3 style="color: var(--primary); margin-bottom: var(--space-xl); text-align: center;">
                    Desglose de la cuenta
                </h3>
            `;

            personTotals.forEach(person => {
                resultHTML += `
                    <div class="person-card" style="margin-bottom: var(--space-lg);">
                        <h4 style="color: var(--primary); margin-bottom: var(--space-md);">${person.name}</h4>
                        
                        ${person.itemsList ? `
                            <div style="margin-bottom: var(--space-md);">
                                <p style="color: var(--gray-700); margin-bottom: var(--space-xs);">Items individuales:</p>
                                ${person.itemsList}
                            </div>
                        ` : ''}
                        
                        ${person.sharedItemsList ? `
                            <div style="margin-bottom: var(--space-md);">
                                <p style="color: var(--gray-700); margin-bottom: var(--space-xs);">Items compartidos:</p>
                                ${person.sharedItemsList}
                            </div>
                        ` : ''}
                        
                        <div class="divider" style="margin: var(--space-md) 0;"></div>
                        
                        <div style="color: var(--gray-700);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                                <span>Subtotal:</span>
                                <span>$${person.subtotal.toFixed(2)}</span>
                            </div>
                            ${person.tip > 0 ? `
                                <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                                    <span>Propina (${person.tip}%):</span>
                                    <span>$${person.tipAmount.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; font-weight: bold; color: var(--primary); margin-top: var(--space-xs);">
                                <span>Total:</span>
                                <span>$${person.total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            resultHTML += `
                <div class="divider" style="margin: var(--space-lg) 0;"></div>
                <div style="text-align: center;">
                    <h4 style="color: var(--primary); margin-bottom: var(--space-xs);">Total General</h4>
                    <p style="font-size: 1.5em; font-weight: bold; color: var(--primary);">$${totalGeneral.toFixed(2)}</p>
                </div>
            `;

            modalContent.innerHTML = resultHTML;
            showModal();
        }

        function showModal() {
            const modal = document.getElementById('resultsModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('resultsModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('resultsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        function resetCalculator() {
            if (confirm('¿Estás seguro de que quieres comenzar una nueva cuenta? Se perderán todos los datos actuales.')) {
                // Reiniciar variables
                personCount = 0;
                sharedItemCount = 0;

                // Limpiar contenedores
                document.getElementById('people-container').innerHTML = '';
                document.getElementById('shared-items-container').innerHTML = '';
                document.getElementById('calculateButton').style.display = 'none';

                // Cerrar modal
                closeModal();

                // Reiniciar botón de inicio
                const startButton = document.getElementById('startButton');
                startButton.style.display = 'block';
                startButton.textContent = 'Comenzar';
                startButton.onclick = addFirstPerson;
                startButton.className = 'button button-primary';
            }
        }
    </script>
</body>
</html>
